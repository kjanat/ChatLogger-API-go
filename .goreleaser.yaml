version: 2

project_name: chatlogger-api-go

before:
  hooks:
    - go mod tidy

builds:
  - id: server
    main: ./cmd/server
    binary: "{{ .ProjectName }}-server_{{ .Version }}-{{ .Os }}_{{ .Arch }}"
    ldflags: ['-s -w -X "github.com/kjanat/chatlogger-api-go/internal/version.Version={{.Version}}" -X "github.com/kjanat/chatlogger-api-go/internal/version.BuildTime={{.Date}}" -X "github.com/kjanat/chatlogger-api-go/internal/version.GitCommit={{.Commit}}"']
    goos: [linux, windows, darwin]
    goarch: [amd64, arm64]
    env: [CGO_ENABLED=0]

  - id: worker
    main: ./cmd/worker
    binary: "{{ .ProjectName }}-worker_{{ .Version }}-{{ .Os }}_{{ .Arch }}"
    ldflags: ['-s -w -X "github.com/kjanat/chatlogger-api-go/internal/version.Version={{.Version}}" -X "github.com/kjanat/chatlogger-api-go/internal/version.BuildTime={{.Date}}" -X "github.com/kjanat/chatlogger-api-go/internal/version.GitCommit={{.Commit}}"']
    goos: [linux, windows, darwin]
    goarch: [amd64, arm64]
    env: [CGO_ENABLED=0]

signs:
  - artifacts: all
    cmd: cosign
    args:
      - sign-blob
      - --key=env://COSIGN_PRIVATE_KEY
      - --yes
      - --output-signature=${signature}
      - ${artifact}
    stdin: ""

archives:
  - name_template: "{{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    files:
      - LICENSE
      - README.md
      - migrations/*

checksum:
  name_template: "{{ .ProjectName }}_checksums.txt"

nfpms:
  - id: chatlogger-api-go
    package_name: "{{ .ProjectName }}"
    vendor: kjanat
    homepage: "{{ .Env.URL }}"
    maintainer: Kaj Kowalski <chatlogger-api-go@kjanat.com>
    description: "{{ .Env.DESCRIPTION }}"
    license: MIT
    formats:
      - deb
      - rpm
      - apk
    dependencies:
      - postgresql
    contents:
      - src: ./migrations/
        dst: /var/lib/chatlogger/migrations
        type: tree
      - src: ./scripts/systemd/chatlogger.service
        dst: /etc/systemd/system/chatlogger.service
        type: config
    scripts:
      postinstall: "./scripts/package/postinstall.sh"
      preremove: "./scripts/package/preremove.sh"

kos:
  - id: server
    build: server
    repositories: [ghcr.io/kjanat/chatlogger-api-server]
    labels:
      title: "{{ .ProjectName }}"
      description: "{{ .Env.DESCRIPTION }}"
      url: "https://github.com/users/kjanat/packages/container/package/chatlogger-api-server"
      source: "{{ .Env.URL }}"
      version: "{{.Version}}"
      created: "{{ .Date }}"
      revision: "{{ .FullCommit }}"
      licenses: "MIT"
      vendor: "kjanat"
    tags:
      - latest
      - "{{.Tag}}"
      - "{{.Major}}"
      - "{{.Major}}.{{.Minor}}"
      - "{{.Version}}"
    bare: true
    preserve_import_paths: false
    platforms:
      - linux/amd64
      - linux/arm64
      - darwin/amd64
      - darwin/arm64
    ko_data_creation_time: "{{.CommitTimestamp}}"
    env:
      - GIN_MODE=release

  - id: worker
    build: worker
    repositories: [ghcr.io/kjanat/chatlogger-api-worker]
    labels:
      title: "{{ .ProjectName }}"
      description: "{{ .Env.DESCRIPTION }}"
      url: "https://github.com/users/kjanat/packages/container/package/chatlogger-api-worker"
      source: "{{ .Env.URL }}"
      version: "{{.Version}}"
      created: "{{ .Date }}"
      revision: "{{ .FullCommit }}"
      licenses: "MIT"
      vendor: "kjanat"
    tags:
      - latest
      - "{{.Tag}}"
      - "{{.Major}}"
      - "{{.Major}}.{{.Minor}}"
      - "{{.Version}}"
    bare: true
    preserve_import_paths: false
    platforms:
      - linux/amd64
      - linux/arm64
      - darwin/amd64
      - darwin/arm64
    ko_data_creation_time: "{{.CommitTimestamp}}"
    env:
      - GIN_MODE=release

docker_signs:
  - artifacts: manifests
    args:
      - sign
      - --key=env://COSIGN_PRIVATE_KEY
      - --yes
      - ${artifact}
    stdin: ""
